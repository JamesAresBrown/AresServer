<!DOCTYPE html>
<html lang="">
<head>
    <meta charset="UTF-8">
    <title>SLAM Lab</title>

    <style>
        /* 设置包含 Three.js 渲染器的容器居中 */
        #pointCloudContainer {
            position: absolute;
            top: 50%;
            left: 50%;
            /*transform: translate(-50%, -50%);*/
        }
    </style>



</head>
<!--<body style="background-color: #0F142D;">-->
<body style="background-color: #ffffff;">

<style>
    /* 将图片宽度设置为父元素宽度的80% */
    img {
        max-width: 600px;
        height: auto; /* 保持原始宽高比 */
        display: block; /* 确保图片居中显示 */
        margin: 0 auto;
    }
</style>
<img src="./head.jpg" title="awsl" alt="Image">
<img src="./tutorial.gif" title="awsl" alt="Image">

<div id="login" style="text-align: center;">
    <form action="2" method="post">
        <label>
            <input id="nameContent" class="login" type="text" name="user" placeholder="用户名" required="required">
        </label>
        <label>
            <input id="passwordContent" class="login" type="password" name="password" placeholder="登录密码">
        </label>
        <button id="loadButton" class="login" type="button" onclick="load()">登录</button>
        <button id="toRegisterButton" class="login" type="button" onclick="toRegister()">注册</button>
    </form>
</div>

<div id="register" style="text-align: center;">
    <form action="3" method="post">
        <label>
            <input id="registerNameContent" class="register" type="text" name="registerUser" placeholder="新用户名" required="required">
        </label>
        <label>
            <input id="registerPasswordContent" class="register" type="password" name="registerPassword" placeholder="新登录密码">
        </label>
        <button id="registerButton" class="register" type="button" onclick="register()">注册</button>
    </form>
</div>


<div id="process" style="text-align: center;">
    <p id="usernameDisplay">User: No User</p>
<!--    <h2>上传 ZIP 压缩包</h2>-->
    <input type="file" id="fileInput" class="process" accept=".zip" onchange="handleFileChange()" disabled>
    <button type="button" id="uploadButton" class="process" onclick="uploadFile()" disabled>上传</button>
    <button type="button" id="processButton" class="process" onclick="processFile()" disabled>处理</button>
    <button type="button" id="downloadButton" class="process" onclick="downloadFile()" disabled>下载</button>
    <button type="button" id="logoutButton" class="process" onclick="logout()" disabled>注销</button>
    <button type="button" id="getExampleButton" class="process" onclick="getExample()">下载测试用例</button>
</div>

<div id="pointsShow" style="text-align: center;">
    <style>
        #pointCloudCanvas {
            background-color: #f0f0f0; /* 设置背景色为浅灰色 */
            padding: 20px; /* 可选：添加一些填充 */
        }
    </style>
    <canvas id="pointCloudCanvas" width="500" height="300"></canvas>
</div>

<!--<style>-->
<!--    #pointCloudContainer {-->
<!--        width: 500px; /* 设置容器宽度 */-->
<!--        height: 300px; /* 设置容器高度 */-->
<!--        position: absolute; /* 将容器定位为绝对位置 */-->
<!--        top: 50%; /* 将容器的顶部置于父容器的50%位置 */-->
<!--        left: 50%; /* 将容器的左侧置于父容器的50%位置 */-->
<!--        transform: translate(-50%, -50%); /* 使用 transform 属性将容器居中 */-->
<!--        border: 1px solid black; /* 可选：添加边框 */-->
<!--    }-->
<!--</style>-->
<!--<div id="pointCloudContainer" style="text-align: center;"></div>-->


<footer>
    <style>
        body {
            margin: 0;
        }

        /* 底部样式 */
        footer {
            background-color: #f2f2f2; /* 背景色 */
            padding: 20px; /* 内边距 */
            text-align: center; /* 文本居中 */
        }

        footer p {
            margin: 10px 0; /* 上下边距 */
            color: #333; /* 文本颜色 */
        }

        footer a {
            color: #0066cc; /* 链接颜色 */
            text-decoration: none; /* 去掉下划线 */
        }

        footer a:hover {
            text-decoration: underline; /* 鼠标悬浮时添加下划线 */
        }
    </style>
    <p>© 2024 示例网站 版权所有 <a href="http://www.beian.miit.gov.cn/" target="_blank">陕ICP备2024032918号-1</a></p>
</footer>

<script>
    var fileContent = '';
</script>
<script>

    var name = '';
    var pw = '';

    var token = '';
    function addToken(xhr) {
        if (token !== '')
            xhr.setRequestHeader('Authorization', token);
    }

    function setVisibleDisable(elementId, disable) {
        const element = document.getElementById(elementId);
        if (disable) {
            element.style.visibility = "hidden";
            element.style.pointerEvents = "none";
        } else {
            element.style.visibility = "visible";
            element.style.pointerEvents = "auto";
        }
    }
    function setVisibleDisableClass(className, disable) {
        const elements = document.getElementsByClassName(className);
        for (let i = 0; i < elements.length; i++) {
            if (disable) {
                elements[i].style.visibility = "hidden";
                elements[i].style.pointerEvents = "none";
            } else {
                elements[i].style.visibility = "visible";
                elements[i].style.pointerEvents = "auto";
            }
        }
    }

    // 以class为单位禁用元素
    function setDisableClass(className, able) {
        const elements = document.getElementsByClassName(className);
        for (let i = 0; i < elements.length; i++) {
            elements[i].disabled = able;
        }
    }

    //界面初始化
    setDisableClass("login", false);
    setDisableClass("process", false);
    setVisibleDisableClass("register", true);

    // 登录按钮逻辑
    function load() {
        const username = document.querySelector('input[name="user"]').value;
        const password = document.querySelector('input[name="password"]').value;

        name = username;
        pw = password;

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/2', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        addToken(xhr);

        xhr.onload = function() {
            // 获取响应数据
            if (xhr.status === 200) {
                if (xhr.responseText === 'login_right') {
                    // 处理成功响应
                    alert('登录成功！');
                    setDisableClass("login", true);
                    setVisibleDisableClass("register", true);
                    setDisableClass("process", false);

                    // 获取 Authorization 头的值
                    const authorizationHeader = xhr.getResponseHeader('Authorization');

                    if (authorizationHeader) {
                        // 提取令牌值
                        token = authorizationHeader;
                        // 处理令牌值
                        console.log('Token:', token);
                        // 在这里您可以对令牌值进行进一步处理，例如存储到本地或者传递给其他函数进行处理
                    } else {
                        console.log('Authorization header not found in response.');
                    }

                    // 将用户名和密码设置到对应的元素中
                    document.getElementById('usernameDisplay').textContent = "Username: " + name;
                    document.getElementById('passwordDisplay').textContent = "Password: " + pw;
                } else {
                    alert('登录失败！');
                    setDisableClass("login", false);
                    setDisableClass("process", true);
                }
            } else {
                alert(xhr.status + ' : ' + xhr.responseText);
            }
        };

        var params = 'user=' + encodeURIComponent(username) + '&password=' + encodeURIComponent(password);
        xhr.send(params);
    }
    // 去注册逻辑
    function toRegister() {
        setVisibleDisableClass("register", false);
        setVisibleDisable("toRegisterButton", true);
        setDisableClass("process", true);
    }
    // 注册逻辑
    function register() {
        const username = document.querySelector('input[name="registerUser"]').value;
        const password = document.querySelector('input[name="registerPassword"]').value;

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/3', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        addToken(xhr);

        xhr.onload = function() {
            if (xhr.status === 200) {
                if (xhr.responseText === 'register_right') {
                    alert('注册成功！');
                    setVisibleDisableClass("register", true);
                    setVisibleDisable("toRegisterButton", false);
                    document.getElementById("registerNameContent").value = '';
                    document.getElementById("registerPasswordContent").value = '';
                } else {
                    alert('注册失败！');
                }
            } else {
                alert(xhr.status + ' : ' + xhr.responseText);
            }
        };

        var params = 'user=' + encodeURIComponent(username) + '&password=' + encodeURIComponent(password);
        xhr.send(params);
    }


    // 选择文件逻辑
    function handleFileChange(event) {
        const file = event.target.files[0];
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        fileNameDisplay.textContent = file.name;

        document.getElementById('fileInput').disabled = false;
        document.getElementById('uploadButton').disabled = false;
        document.getElementById('processButton').disabled = true;
        document.getElementById('downloadButton').disabled = true;
    }
    // 上传按钮逻辑
    function uploadFile() {
        setDisableClass("process", true);

        const fileInput = document.getElementById('fileInput');
        let file = fileInput.files[0];

        if (!file) {
            alert('请选择要上传的文件！');
            return;
        }

        const formData = new FormData();
        formData.append('fileSize', file.size.toString());
        formData.append('file', file);
        // formData.append(file.size.toString(), file);


        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/7', true);
        addToken(xhr);

        xhr.onload = function() {
            setDisableClass("process", false);
            document.getElementById('downloadButton').disabled = true;
            if (xhr.status === 200) {
                if (xhr.responseText === 'upload_right') {
                    alert('上传成功，点击处理，等待处理成功响应后，点击下载结果文件。');
                    file = null;
                } else {
                    alert('注册失败！');
                }
            } else {
                if (403 === xhr.status) {
                    alert(xhr.status + ' : ' + xhr.responseText + '\n 连接失败，请重新连接。');
                    logout()
                } else {
                    alert(xhr.status + ' : ' + xhr.responseText);
                }
            }

            const fileInput = document.getElementById('fileInput');
            fileInput.value = "";  // 清空文件输入框

            const fileNameDisplay = document.getElementById('fileNameDisplay');
            fileNameDisplay.textContent = "未选择文件";  // 重置文件名显示
        };

        xhr.send(formData);
    }
    // 处理按键逻辑
    function processFile() {
        fileContent = '';
        setDisableClass("process", true);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/9', true);
        addToken(xhr);

        xhr.onload = function() {
            setDisableClass("process", false);
            if (xhr.status === 200) {
                alert('处理成功，点击下载。');
                document.getElementById('downloadButton').disabled = false;
                // 解析服务器返回的文件并下载
                fileContent = xhr.responseText;
                displayPLYFileContent2(fileContent);
            } else {
                if (403 === xhr.status) {
                    alert(xhr.status + ' : ' + xhr.responseText + '\n 连接失败，请重新连接。');
                    logout()
                } else {
                    alert(xhr.status + ' : ' + xhr.responseText + '\n 检查上传的数据是否有误，如果数据有误请重新上传。或者试试重新处理。');
                }
            }
        };

        xhr.send();
    }
    // 下载文件逻辑
    function downloadFile() {
        if (fileContent !== '') {
            const blob = new Blob([fileContent], {type: 'application/octet-stream'});
            const url = URL.createObjectURL(blob);

            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = 'res.ply';
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
    }
    // 注销按键逻辑
    function logout() {
        setDisableClass("process", true);
        setDisableClass("login", false);
        setVisibleDisableClass("register", true);
        document.getElementById("nameContent").value = '';
        document.getElementById("passwordContent").value = '';
        document.getElementById("registerNameContent").value = '';
        document.getElementById("registerPasswordContent").value = '';
    }

    // 解析PLY文件内容并绘制到Canvas上
    function displayPLYFileContent2(fileContent) {
        const lines = fileContent.trim().split('\n');
        const canvas = document.getElementById('pointCloudCanvas');
        const ctx = canvas.getContext('2d');

        // 清空Canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 解析顶点数据
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line === "end_header") {
                // 顶点数据开始于"end_header"行之后
                for (let j = i + 1; j < lines.length; j++) {
                    const vertexData = lines[j].trim().split(' ');
                    const x = parseFloat(vertexData[0]);
                    const y = parseFloat(vertexData[1]);
                    const z = parseFloat(vertexData[2]);
                    const r = parseInt(vertexData[6]);
                    const g = parseInt(vertexData[7]);
                    const b = parseInt(vertexData[8]);

                    // 假设这里绘制一个半径为1的点
                    ctx.fillStyle = `rgb(${r},${g},${b})`;
                    ctx.beginPath();
                    ctx.arc(x * 50 + canvas.width / 2, y * 50 + canvas.height / 2, 1, 0, 2 * Math.PI);
                    ctx.fill();
                }
                break;
            }
        }
    }

    function getExample() {
        // 创建 XMLHttpRequest 对象
        var xhr = new XMLHttpRequest();

        // 设置请求类型和地址
        xhr.open('POST', './ET.zip', true);
        addToken(xhr);

        // 设置响应类型
        xhr.responseType = 'blob';
        // let fileContent = '';
        xhr.onload = function() {
            if (xhr.status === 200) {
                alert('下载成功');

                var blob = xhr.response;
                var downloadLink = document.createElement('a');
                downloadLink.href = window.URL.createObjectURL(blob);
                downloadLink.download = 'ET.zip';
                downloadLink.style.display = 'none';
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            } else {
                // 处理错误
                alert('下载失败，请重试！');
            }
        };

        xhr.onerror = function() {
            // 处理错误
            alert('下载失败，请重试！');
        };

        xhr.send();
    }

</script>



<!--<script type="module">-->
<!--    import * as THREE from "./js/three.js/build/three.module.min.js";-->
<!--    let scene, camera, renderer, points;-->

<!--    init();-->
<!--    animate();-->

<!--    function init() {-->
<!--        // 基础场景设置-->
<!--        scene = new THREE.Scene();-->
<!--        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);-->
<!--        renderer = new THREE.WebGLRenderer();-->
<!--        renderer.setSize(window.innerWidth*0.4, window.innerHeight*0.4);-->
<!--        // document.body.appendChild(renderer.domElement);-->
<!--        document.getElementById('pointCloudContainer').appendChild(renderer.domElement);-->

<!--        // 创建一个球体，用于确定相机的位置-->
<!--        const sphere = new THREE.SphereGeometry(1, 32, 32);-->
<!--        const material = new THREE.MeshBasicMaterial({ color: 0xffffff });-->
<!--        const mesh = new THREE.Mesh(sphere, material);-->
<!--        // scene.add(mesh);-->

<!--        // 设置相机的位置，使其位于球体上方，朝向球体中心-->
<!--        camera.position.set(0, 0, 15);-->
<!--        camera.lookAt(mesh.position);-->
<!--    }-->


<!--    function animate() {-->
<!--        requestAnimationFrame(animate);-->

<!--        // 如果点云已经存在，执行动画效果-->
<!--        if (points) {-->

<!--            // 简单的动画效果-->
<!--            points.rotation.x += 0.005;-->
<!--            points.rotation.y += 0.005;-->

<!--            renderer.render(scene, camera);-->
<!--        }-->

<!--        renderer.render(scene, camera);-->
<!--    }-->



<!--    // 显示点云的函数，参数为点云数据-->
<!--    function displayPLYFileContent2(fileContent) {-->
<!--        // 清除之前的点云（如果存在）-->
<!--        if (points) {-->
<!--            scene.remove(points);-->
<!--            points.geometry.dispose();-->
<!--            points.material.dispose();-->
<!--        }-->

<!--        // 点云材料-->
<!--        const material = new THREE.PointsMaterial({ vertexColors: true, size: 0.05 });-->

<!--        // 点云几何体-->
<!--        const geometry = new THREE.BufferGeometry();-->
<!--        const vertices = [];-->
<!--        const colors = [];-->

<!--        // 解析PLY文件-->
<!--        const lines = fileContent.split('\n');-->
<!--        let start = false;-->
<!--        for (let line of lines) {-->
<!--            if (line === "end_header") {-->
<!--                start = true;-->
<!--                continue;-->
<!--            }-->
<!--            if (start) {-->
<!--                const parts = line.split(' ');-->
<!--                vertices.push(parseFloat(parts[0]), parseFloat(parts[1]), parseFloat(parts[2]));-->
<!--                colors.push(parseInt(parts[6]) / 255, parseInt(parts[7]) / 255, parseInt(parts[8]) / 255);-->
<!--            }-->
<!--        }-->

<!--        geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));-->
<!--        geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));-->

<!--        points = new THREE.Points(geometry, material);-->
<!--        scene.add(points);-->
<!--    }-->
<!--    window.displayPLYFileContent2 = displayPLYFileContent2;-->


<!--</script>-->

</body>
</html>
